---
title: "Predicting Housing Prices for Mecklenberg County, NC - MUSA508 Midterm"
author: "Rui Jiang, Jingyi Cai"
date: '2022-09-25'
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup}
#set some global options for knitting chunks

#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)

# Load some libraries

library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(tidycensus)
library(geojsonio)
library(stargazer)
library(utils)
library(rgdal)
library(stargazer)

# functions and data directory
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")

```

```{r}
```



```{r read_data}
primary.data<-
  st_read("https://raw.githubusercontent.com/mafichman/MUSA_508_Lab/main/Midterm/data/2022/studentData.geojson")%>%
  st_transform('EPSG:2264')

```


```{r split_data}
primary.data<-
  primary.data%>%
  filter(price<10000000)

mklb.sf <- 
  primary.data %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 2264, agr = "constant") %>%
  st_transform('EPSG:2264')

numericVars <- 
  select_if(st_drop_geometry(mklb.sf), is.numeric) %>% na.omit()  
  
topredict <-
  mklb.sf%>%
  filter(toPredict!="CHALLENGE")

topredict_num <-
  select_if(st_drop_geometry(topredict), is.numeric) %>% na.omit() 

challenge <-
  mklb.sf%>%
  filter(toPredict=="CHALLENGE")

challenge_num<-
  select_if(st_drop_geometry(challenge), is.numeric) %>% na.omit()  

```

dplyr::select(-lot_num, -nc_pin, -condo_town, -parcel_typ, -commonpid,
                -taxpid,-ownerlastn,-ownerfirst,-cownerfirs,-cownerlast,
                -houseno,-houseunit,-stdir,-stname,-sttype,-stsuffix,
                -codemunici,-municipali,-mailaddr1,-mailaddr2,-city,-state,-zipcode)



```{r school}
#school data
cmpd_school<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/CMS_Schools.geojson?token=GHSAT0AAAAAABY2SI6V7IARZ26MTPWPDI2CY2FSNIA') %>%
  st_transform('EPSG:2264')
# bus
cmpd_busstation<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/CATS_BusStops.json?token=GHSAT0AAAAAABY2SI6UBWZKXFSMLI5LU7VGY2FSYSQ') %>%
  st_transform('EPSG:2264')
# firestation
cmpd_firestation<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/CFD_FireStations.geojson?token=GHSAT0AAAAAABY2SI6UDJGGNYHRO7GJNCVIY2FSN7A') %>%
  st_transform('EPSG:2264')

# church
cmpd_church<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/Churches.geojson?token=GHSAT0AAAAAABY2SI6V2M4GBBV6YXWWYI2OY2FSOKA') %>%
  st_transform('EPSG:2264')

# medical facilities
cmpd_medical<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/MedicalFacilities.geojson?token=GHSAT0AAAAAABY2SI6VPWUPG5FYF5X2J3K4Y2FSOWA') %>%
  st_transform('EPSG:2264')
# park
cmpd_park<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/geojson/Park_Locations.geojson?token=GHSAT0AAAAAABY2SI6UWECBTASYEKE4YONKY2FSO7Q') %>%
  st_transform('EPSG:2264')
# police
cmpd_police<-
  st_read('https://raw.githubusercontent.com/RumRon/MUSA_508/main/Midterm/CMPD_Police_Offices.geojson?token=GHSAT0AAAAAABY2SI6VMVN5KTM3VMNBKN3SY2FSPPQ') %>%
  st_transform('EPSG:2264')
```

```{r}
# mutate z = 0
#firestation
cmpd_firestation.sf <- st_coordinates(cmpd_firestation)
cmpd_firestation.sf <- cmpd_firestations.sf[, -3]

cmpd_church.sf <-st_coordinates(cmpd_church)
cmpd_church.sf <- cmpd_church.sf[, -3]

cmpd_medical.sf <-st_coordinates(cmpd_medical)
cmpd_medical.sf <- cmpd_medical.sf[, -3]
```


```{r to_k}
mklb.sf <- 
  mklb.sf %>% 
     mutate(
       police_nn1 = nn_function(st_coordinates(mklb.sf), 
                                st_coordinates(police.sf), k = 1),
       police_nn2 = nn_function(st_coordinates(mklb.sf), 
                                st_coordinates(police.sf), k = 2),
       police_nn3 = nn_function(st_coordinates(mklb.sf), 
                                st_coordinates(police.sf), k = 3),
       school_nn1 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(school.sf), k = 1),
       school_nn2 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(school.sf), k = 2),
       school_nn3 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(school.sf), k = 3),
       park_nn1 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(park.sf), k = 1),
       park_nn2 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(park.sf), k = 2),
       park_nn3 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(park.sf), k = 3),
       firestation_nn1 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(firestation.sf), k = 1),
       firestation_nn2 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(firestation.sf), k = 2),
       firestation_nn3 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(firestation.sf), k = 3),
       church_nn1 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(church.sf), k = 1),
       church_nn2 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(church.sf), k = 2),
       church_nn3 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(church.sf), k = 3),
       medical_nn1 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(medical.sf), k = 1),
       medical_nn2 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(medical.sf), k = 2),
       medical_nn3 = nn_function(st_coordinates(mklb.sf), 
                              st_coordinates(medical.sf), k = 3))

```




```{r}
#figure out when k =1
topredict <- 
  topredict %>% 
     mutate(
       school_nn1 = nn_function(st_coordinates(topredict), 
                              st_coordinates(cmpd_school.sf), k = 1),
       school_nn2 = nn_function(st_coordinates(topredict), 
                              st_coordinates(cmpd_school.sf), k = 2))
```



```{r }
# ggplot, reorder
# ggplot, reorder
acs_variable_list.20 <- load_variables(2020, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)
tracts20 <- 
  get_acs(geography = "tract", variables = c("B25026_001E","B02001_002E","B15001_050E",
                                             "B15001_009E","B19013_001E","B25058_001E",
                                             "B06012_002E","B28010_007E","B08101_001E",
                                             "B09001_001E","B09001_003E","B09021_002E",
                                             "B11001I_001E", "B14001_009E",
                                             "B17001_002E","B27001_001E","B18101_001E",
                                             "B19001_001E","B25001_001E","B25040_001E"), 
          year=2020, state=37, county=119, geometry=T, output="wide") %>%
  st_transform('EPSG:2264') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E,
         Nocom = B28010_007E, 
         Waytowork = B08101_001E,
         Popunder18 = B09001_001E, 
         Popunder3 = B09001_003E,
         Singleadult = B09021_002E, 
         Householdtype = B11001I_001E,
         Addmittogra = B14001_009E,
         Poverty  = B17001_002E,
         Healthins  = B27001_001E,
         Disable  = B18101_001E,
         Familyincome  = B19001_001E,
         Housingunits  = B25001_001E,
         Househeatingfuel  = B25040_001E)%>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2020") 

```
```{r }
# Mapping data
ggplot() +
  geom_sf(data = st_union(tracts20), fill = "grey40") +
   geom_sf(data = topredict, aes(colour = (price)), 
          show.legend = "point", size = .25) +
  scale_fill_viridis_c() +
  labs(title="try") +
  mapTheme()
```



# 1. Introduction
Zillow has realized that its housing market predictions are not as accurate as they could be because they do not factor in enough local intelligence. As such they have asked us to build a better predictive model of home prices for Mecklenberg County, NC.
This model aims to build an accurate and generalizable hedonic model that predicts home prices for Mecklenberg County, NC by deconstructing overall home price into the value of constituent parts. Accurate models lead to only small differences between the predicted and observed values, and generalizable models accurately predict on new data and with comparable accuracy across various groups. By working to improve the accuracy and generalizability of the predictive model, we are ultimately striving to create a more useful decision-making tool. Such a model may be useful for local governments as they assess property taxes, for example.

# 2. Data Manipulation and Visualization
## 2.0 Setup
In this section, we loaded necessary libraries, created plot theme options and map theme options, and identified functions of quintile breaks, and average nearest neighbor distance for further analysis.

## 2.1 Data Wrangling
In this section, we loaded Mecklenburg County data and other complementary datasets and conducted feature selection and engineering. Besides, for other analyses, we separate the whole dataset into and in advance of Mecklenburg. 

Five categorical datasets were used in this project:
**Mecklenburg County House Price and Internal Characteristics:** basic geometric dataset provided by the course in advance.

**Mecklenburg County Base Data:** geometric data containing the geographic information of Mecklenburg County. 
Mecklenburg County Beach Neighborhood: As an alternative way to using neighborhood data of Mecklenburg County Beach, we used Mecklenburg County Municipal Boundary data that is a polygon feature class of municipal boundaries within Mecklenburg County-Dade County, and specifically filter geometric data in Mecklenburg County Beach.

**Census Data:** demographic variables from the ACS 2017 for census tracts in Mecklenburg County. We specifically selected 8 variables in the analysis:

<p style="padding-left:2em;">
**•	TotalPop:** Total population in each census tract
**•	Whites:** White population in each census tract
**•	MedHHInc:** Median household income in each census tract
**•	MedRent:** Median Rent for properties in each census tract
**•	TotalPoverty:** Population living under the level of poverty in each census tract
**•	TotalUnit:** Total housing units in each census tract
**•	pctWhite:** white population proportion in each census tract
**• pctBachelors:** Bachelor population proportion in each census tract
**•	pctPoverty:** Poverty population proportion in each census tract
**•	pctTotalVacant: **Vacant unites proportion in each census tract
•	</p>

**Amenity Data:** most of the data come from the website of government: http://maps.co.mecklenburg.nc.us/openmapping/data.html.Compilatory data were chosen for describing amenities and public services of Mecklenburg County. The datasets we chose encompasses fireplace, police station, education opportunity, healthcare service, and entertainment accessibility. See each dataset below:

<p style="padding-left:2em;">
**1.	Public School:** Dataset contains points representing Elementary, Middle, and High Schools in Mecklenburg County.
**2.	Bus station: ** A point feature class of CATS Bus Stops for Mecklenburg County.
**3.	Fire station : ** Geographical representation of the physical locations of the Charlotte Fire Department Fire Stations.
**4.	Church : ** Churches dataset defines locations classified as religious organizations in Mecklenburg County, data is queried from Master Address Table.
**5.	Medical Facilities: ** This dataset was generated to publish a geospatial inventory of Medical Facilities in Mecklenburg County, NC. This data serves to support and assist the Charlotte Mecklenburg Planning Department, The City of Charlotte, and others in Urban Planning decisions. 
**6.	Park : ** Park amenities for all parks in Mecklenburg County, including Charlotte, Davidson, Cornelius, Davidson, Huntersville, Matthews, Mint Hill, and Pineville. 
**7.	Police: ** Charlotte-Mecklenburg Police Department Stations.
</p>


## 2.2 Summary Statistics
Present a table of summary statistics with variable descriptions. 
We sort these variables by their category (internal characteristics, amenities/public services or spatial structure).

## 2.3 Correlation Matrix
For better visualization, features were divided into internal characteristics and amenity again when creating correlation matrix. Based on the graduated color, some features have strong relation with Sale Price, such as bathroom, fireplace and house age.
**Internal characteristics:**
```{r correlation_matrix}
#internal features
internal_feature <- mklb.sf%>%
  dplyr::select(commonpid,price,age,storyheigh,heatedarea,numfirepla,totalac,
                fullbaths,halfbaths,bedrooms,units,prisqft)%>%
  rename(LivingArea = heatedarea)


internal_feature <-
  select_if(st_drop_geometry(internal_feature), is.numeric) %>% na.omit()

ggcorrplot(
  round(cor(internal_feature), 1), 
  p.mat = cor_pmat(internal_feature),
  colors = c('#05A167', "white", '#6897BB'),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables\n(internal features)\n",
       caption = 'Figure DATA 3.1') 
    plotTheme()
```

**Amenity :**
```{r correlation_matrix}
# Amenity
Amenity <- mklb.sf%>%
  dplyr::select(price,prisqft,police_nn1, police_nn2, police_nn3, school_nn1, school_nn2, school_nn3, church_nn1, church_nn2, church_nn3, park_nn1, park_nn2, park_nn3,firestation_nn1, firestation_nn2, firestation_nn3, medical_nn1, medical_nn2, medical_nn3,police_nn1, police_nn2, police_nn3)

Amenity <-
  select_if(st_drop_geometry(Amenity), is.numeric) %>% na.omit()

ggcorrplot(
  round(cor(Amenity), 1), 
  p.mat = cor_pmat(Amenity),
  colors = c('#05A167', "white", '#6897BB'),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables\n(Amenity)\n",
       caption = 'Figure DATA 3.1') 
    plotTheme()
```

## 2.4 Home prices scatterplots
In this section, we specifically explored the correlation between sale price and four interesting and meaningful features: 
SalePrice/Square Feet; SalePrice/Percentage of Poverty; SalePrice/Nearest Three Public Schools

Through graphs below, it is obvious that the first three of four features are positively correlated to sale price, while the distance to nearest hospital is negatively correlated to the sale price that is consistent with our intuition.



## 2.5 Map Home Prices
Develop 1 map of your dependent variable (sale price)
## 3 interesting maps
Develop 3 maps of 3 of your most interesting independent variables.
## This criterion is linked to a Learning OutcomeBonus for something extra engaging
Include any other maps/graphs/charts you think might be of interest.

# Methods

## Table of results (training set)

## Table of goodness of fit (test set)

## CV Results

## Pred vs Obs Scatterplot

## Residuals Map w/ Moran's I

## Predicted Map (Test Set)

## MAPE map by neighborhood

## Scatterplot - MAPE by neighborhood mean price

## Split by Census Groups

# Discussion
Is this an effective model? What were some of the more interesting variables?  How much of the variation in prices could you predict? Describe the more important features? Describe the error in your predictions?  According to your maps, could you account the spatial variation in prices?  Where did the model predict particularly well? Poorly? Why do you think this might be?
## Accuracy

## Generalizability

# Conclusion
Would you recommend your model to Zillow? Why or why not? How might you improve this model? 



